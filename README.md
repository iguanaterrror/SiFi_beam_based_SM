# Proton Range Reconstruction Toolkit

This repository contains the Python code developed for my bachelor's thesis. It is focused on the creation of a beam-based system matrix that can be used in MLEM-based proton therapy dose range reconstruction.




## Requirements and Setup

- **Python 3.x** (recommended to use a dedicated [Conda](https://docs.conda.io/en/latest/) environment)  
- **Scientific Python packages:**  
  - [numpy](https://numpy.org/)  
  - [matplotlib](https://matplotlib.org/)  
  - [scipy](https://scipy.org/)  
  - [uproot](https://github.com/scikit-hep/uproot) – for reading ROOT files without ROOT GUI  
  - [mplhep](https://github.com/scikit-hep/mplhep) – for HEP-style plotting  

- **Custom SiFi-CM modules:**  
  - `sifi_cm.root_aux`  
  - `sifi_cm`  
  - `sifi_cm.data_fit`  
These modules are available in the [SiFi-CM-Python repository, `heidelberg_analysis` branch](https://github.com/SiFi-CC/SiFi-CM-Python/tree/heidelberg_analysis) and must be installed or accessible in your Python environment.

- **Geant4 simulations code (for generating detector response ROOT files):**  
  - Repository: [SiFi-CC/G4Simulation](https://github.com/SiFi-CC/G4Simulation)  
  - The analysis scripts expect ROOT files containing the **detector response** produced by this code. These files are then processed to create hitmaps used in the reconstruction. Make sure you have run the simulations (using `sim_one_file.sh` or `sim_all.sh`) to generate the necessary ROOT files.


> **Note:** Using a Conda environment is highly recommended to manage dependencies and avoid conflicts. You can create one with all required packages and activate it before running the scripts.

## Workflow

The typical workflow for using this toolkit is as follows:

1. **Convert phase-space files to TSV**  
   Use the `convert.C` ROOT macro to transform raw phase-space files into TSV format for easier handling in simulations.  

2. **Run simulations**  
   Use `sim_all.sh` to run simulations based on the converted TSV files.  

3. **Merge results**  
   Combine multiple simulation outputs using `merge_root.sh` to produce consolidated ROOT files.  

4. **Create hitmaps**  
   Generate hitmaps from the merged ROOT files using the `createHitmaps.C` macro.  

5. **Analyze hitmaps**  
   Perform analysis with `sm_lib.py`, which contains functions for range reconstruction, Bragg peak detection, and system matrix preparation.  

6. **Example analysis**  
   A full example of beam-based reconstruction is provided in `clean_beam_based_reco.ipynb`.


## Usage

### `convert.C`

`convert.C` is a ROOT macro used to **convert phase-space ROOT files into TSV format** for subsequent simulations and analysis. It provides flexible functions to process individual ROOT files, single folders, or entire directories of ROOT files organized by energy.

**Key features:**

- Reads the `Secondaries` TTree from ROOT files and filters **gamma particles** (`ParticleID == 22`).
- Applies a **spatial cut** to select particles within detector bounds.
- Writes particle information (ID, energy, position, momentum) to TSV files.
- Supports:
  - Single ROOT file conversion (`root_to_tsv`)
  - Single folder conversion (`convert_one_folder`)
  - Batch conversion for multiple energy folders (`convert_all_energies`)
  - Flexible directory conversion with optional folder prefix (`convert`)

**Usage Example:**

```bash
root -l
.L convert.C
convert_all_energies("input_folder", "output_folder")
```
### `sim_one_file.sh` and `sim_all.sh`

These Bash scripts handle the **simulation workflow** for TSV-based input files using the G4Simulation code.

#### `sim_one_file.sh`
- Runs a **single simulation chunk**.
- Arguments:
  1. Chunk name
  2. Merged TSV input file
  3. Output ROOT file
  4. Log file
- Loads the Geant4 environment and executes the custom simulation binary with the appropriate detector, mask, and source settings.
- Logs success, failure, or crashes for each chunk.
- **Simulation code:** The actual simulation is executed using the [SiFi-CC/G4Simulation](https://github.com/SiFi-CC/G4Simulation) repository.

#### `sim_all.sh`
- Processes **multiple TSV files in chunks**.
- Merges TSV files into chunks and runs `sim_one_file.sh` for each chunk.
- Supports **parallel execution** with a configurable maximum number of concurrent jobs.
- Logs the simulation progress and completion times.
- Handles memory management and skips already processed chunks.

**Usage Example:**

```bash
# Run all simulations in TSV folder
./sim_all.sh
```

### `merge_root.sh`

`merge_root.sh` is a Bash script used to **merge ROOT files** generated by simulations into consolidated ROOT files for easier analysis.

**Key features:**

- Loops over subdirectories containing simulation ROOT files.
- Skips files that are **too small** (less than 50 KB).
- Limits each combined file to a **maximum chunk size** (default 300 MB) to avoid memory issues.
- Uses ROOT’s `hadd` tool to merge valid ROOT files.
- Logs progress, skipped files, and output paths for easy tracking.

**Usage Example:**

```bash
# Merge all ROOT files in the simulation output directory
./merge_root.sh
```

### `createHitmaps.C`

`createHitmaps.C` is a ROOT macro used to **generate hitmap histograms** from simulation ROOT files. These histograms summarize particle hits or energy deposition per detector fiber and layer.

**Key Features:**

- Reads ROOT files containing a TTree named `deposits`.
- Branches used: `fiberID`, `position` (TVector3), and `energy`.
- Creates 2D histograms (fiber vs. layer) for:
  - **Counts** (number of hits)
  - **Energy deposition** (optional)
- Supports multiple energy thresholds.
- Applies **per-layer weights**:
  - Exponential attenuation
  - Optional monotonic corrections
- Normalizes histograms either by total counts or first layer.

**Functions Provided:**

- `rowSums(TH2D* h)` – Compute row sums per layer.
- `applyRowWeights(TH2D* h, const std::vector<double>& w)` – Apply layer-wise weights.
- `weightsExponential(int nLayers, double beta)` – Generate exponential attenuation weights.
- `weightsMonotonic(const std::vector<double>& sums)` – Enforce monotonic decreasing row sums.
- `normalizeTotal(TH2D* h)` – Normalize histogram integral to 1.
- `normalizeFirstLayer(TH2D* h)` – Normalize first layer sum to 1.
- `processFile(const TString& filepath, const TString& outputFilePath, bool energyDepo)` – Create hitmaps from a single ROOT file.
- `processAllRootFilesInDir(const TString& inputDir, const TString& outputDir, bool energyDepo)` – Batch process all ROOT files in a directory.

**Usage Example:**

```bash
root -l
.L createHitmaps.C
processAllRootFilesInDir("input_root_dir", "output_dir", false)
```

### `sm_lib.py`

`sm_lib.py` provides Python tools for **reconstruction and analysis of ROOT histograms** from SiFi-CC simulations using MLEM or cosine similarity. It also supports creating a system matrix for reconstruction.

#### Key Functions

1. **`reco_mlem_from_sim(dataPath, histName, matrFile, nIter, xRange, ...)`**  
   Performs MLEM-based reconstruction from ROOT histograms and optionally compares detected peak ranges with PSTAR reference data.  
   **Features:**  
   - Loads histograms from ROOT files in `dataPath`.  
   - Reconstructs 1D profiles using the system matrix `matrFile`.  
   - Applies Gaussian smoothing and detects peaks.  
   - Returns detected ranges, optional PSTAR comparison metrics (RMSE, correlation, slope), and optionally a plot.  
   - Skips background files automatically.  

2. **`reco_cosine(dataPath, matrFile, xRange, rangesPSTAR, ...)`**  
   Performs reconstruction based on **cosine similarity** between measured histograms and a reference system matrix.  
   **Features:**  
   - Detects peaks in similarity profiles.  
   - Supports plotting and PSTAR comparison.  
   - Useful as a lightweight alternative to MLEM for fast range estimation.  

3. **`create_system_matrix(dataPath, target_energies, histName='hHitmap;1', ...)`**  
   Generates a **system matrix** from ROOT hitmap histograms.  
   **Features:**  
   - Loads and flattens histograms from a folder of ROOT files.  
   - Optionally normalizes columns and interpolates to target energies.  
   - Can display a heatmap of the system matrix for verification.  

4. **`score(result)`**  
   Computes a combined score from MLEM reconstruction metrics (RMSE, correlation, slope) to rank parameter scans.

5. **`find_best_params(dataPath, histName, matrFile, rangesPSTAR, xRange, nMin, nMax, nStep)`**  
   Performs a scan over MLEM iteration numbers and returns the top-performing iterations based on `score()`.  

#### Usage Example

```python
from sifi_cm import sm_lib
import numpy as np

# Create system matrix from ROOT hitmaps
sm, energies = sm_lib.create_system_matrix("root_hitmaps/", target_energies=np.arange(50, 150, 1))

# Reconstruct MLEM profiles
results = sm_lib.reco_mlem_from_sim("sim_root/", "hHitmap;1", sm, nIter=50, xRange=np.linspace(0, 150, 100))

# Reconstruct using cosine similarity
ranges, metrics = sm_lib.reco_cosine("sim_root/", sm, xRange=np.linspace(0, 150, 100), rangesPSTAR={66: 66.5, 102.9: 103.2})
```

## Quick Start Example

See `clean_beam_based_reco.ipynb` for a step-by-step example of creating a system matrix and performing MLEM reconstruction.

> **Note:** PSTAR reference ranges are used to validate reconstructed proton ranges. These values can be obtained from [NIST PSTAR database](https://physics.nist.gov/PhysRefData/Star/Text/PSTAR.html).

## License

This repository is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
